{% extends "core/base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">Cronograma: {{ project.name }}</h1>
            <p class="text-muted">Vista de línea de tiempo de las tareas.</p>
        </div>
        <a href="{% url 'core:project_detail' project_slug=project.slug %}" class="btn btn-outline-primary">
            <i class="bi bi-kanban-fill me-1"></i>Volver al Kanban
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div id="gantt-container"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Ya no necesitamos 'type="module"' ni la línea 'import'

    document.addEventListener('DOMContentLoaded', function() {
        const dataUrl = "{% url 'core:project_gantt_data' project_slug=project.slug %}";

        fetch(dataUrl)
            .then(response => response.json())
            .then(tasks => {
                const gantt_container = document.querySelector("#gantt-container");

                if (!tasks || tasks.length === 0) {
                    gantt_container.innerHTML = "<p class='p-3 text-center text-muted'>No hay tareas para mostrar.</p>";
                    return;
                }

                // Como el script se carga globalmente, la clase 'Gantt' ya existe y podemos usarla.
                try {
                    const gantt = new Gantt("#gantt-container", tasks, {
                        on_click: (task) => {
                            console.log("Clic en la tarea:", task);
                            htmx.ajax('GET', `/workspaces/tasks/${task.id.replace('task_','')}/`, {
                                target: '#modal-container',
                                swap: 'innerHTML'
                            });
                        },
                    });
                } catch (error) {
                    console.error("¡ERROR FATAL AL CREAR EL GRÁFICO!", error);
                }
            });
    });
</script>
<div id="modal-container"></div>
{% endblock %}